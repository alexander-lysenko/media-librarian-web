version: "3.9"
services:
    webapp:
        container_name: media_librarian_webapp
        hostname: webapp
        build: ./docker/local
        env_file: ./src/.env
        ports:
            - "${APP_IP_ADDR:?}:80:80"
        volumes:
            - ./src:/app
            - ./logs:/logs
        depends_on:
            - pgsql
        networks:
            - bridge
        command: [ "webapp" ]
        logging:
            driver: json-file
            options:
                max-size: "128m"
                max-file: "1"
    pgsql:
        container_name: media_librarian_db
        image: postgres:14-alpine
        ports:
            - "${APP_IP_ADDR:?}:5432:5432"
        volumes:
            - ./pgsql_data:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: "${DB_DATABASE:?}"
            POSTGRES_USER: "${DB_USERNAME:?}"
            POSTGRES_PASSWORD: "${DB_PASSWORD:?}"
        networks:
            - bridge
        healthcheck:
            test: [ "CMD", "pg_isready -q -d ${DB_DATABASE} -U ${DB_USERNAME}" ]
networks:
    bridge:
        driver: bridge
